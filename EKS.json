{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "Creates an EKS cluster with a managed node group",
  "Parameters": {
    "Environment": {
      "Type": "String",
      "Default": "Development",
      "Description": "Describe the environment (e.g. development, production)"
    },
    "Subnets": {
      "Type": "List<AWS::EC2::Subnet::Id>",
      "Description": "Describe the environment (e.g. development, production)"
    },
    "SecurityGroups": {
      "Type": "List<AWS::EC2::SecurityGroup::Id>",
      "Description": "Select the security groups for your EKS nodes"
    }
  },
  "Resources": {
    "EKSClusterServiceRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "Service": ["eks.amazonaws.com"]
              },
              "Action": ["sts:AssumeRole"]
            }
          ]
        },
        "ManagedPolicyArns": ["arn:aws:iam::aws:policy/AmazonEKSClusterPolicy"]
      }
    },
    "EKSNodeServiceRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "Service": ["ec2.amazonaws.com"]
              },
              "Action": ["sts:AssumeRole"]
            }
          ]
        },
        "ManagedPolicyArns": [
          "arn:aws:iam::aws:policy/AmazonEKSWorkerNodePolicy",
          "arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryReadOnly",
          "arn:aws:iam::aws:policy/AmazonEKS_CNI_Policy"
        ]
      }
    },
    "EKSCluster": {
      "Type": "AWS::EKS::Cluster",
      "Properties": {
        "Name": "TestCluster",
        "Version": "1.21",
        "RoleArn": { "Fn::GetAtt": "EKSClusterServiceRole.Arn" },
        "ResourcesVpcConfig": {
          "SecurityGroupIds": { "Ref": "SecurityGroups" },
          "SubnetIds": { "Ref": "Subnets" },
          "EndpointPublicAccess": false,
          "EndpointPrivateAccess": true,
          "PublicAccessCidrs": ["1.1.1.2/32"]
        },
        "Logging": {
          "ClusterLogging": {
            "EnabledTypes": [
              {
                "Type": "api"
              },
              {
                "Type": "audit"
              }
            ]
          }
        },
        "Tags": [{ "Key": "Environment", "Value": { "Ref": "Environment" } }]
      }
    },
    "EKSNodeGroup": {
      "Type": "AWS::EKS::Nodegroup",
      "Properties": {
        "ClusterName": { "Ref": "EKSCluster" },
        "NodeRole": { "Fn::GetAtt": "EKSNodeServiceRole.Arn" },
        "ScalingConfig": {
          "MinSize": 0,
          "DesiredSize": 2,
          "MaxSize": 2
        },
        "InstanceTypes": ["t3.micro"],
        "Labels": {
          "Type": "EC2NodeGroup"
        },
        "Subnets": { "Ref": "Subnets" }
      }
    }
  },
  "Outputs": {
    "EKSClusterServiceRoleArn": {
      "Value": { "Fn::GetAtt": "EKSClusterServiceRole.Arn" }
    },
    "EKSNodeServiceRoleArn": {
      "Value": { "Fn::GetAtt": "EKSNodeServiceRole.Arn" }
    }
  }
}
