{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "Creates an EKS cluster with a managed node group",
  "Parameters": {
    "Project": {
      "Type": "String",
      "Default": "MyProject",
      "Description": "Enter a project name"
    },
    "Environment": {
      "Type": "String",
      "Default": "Development",
      "Description": "Describe the environment (e.g. development, production)"
    },
    "EKSNodesSubnets": {
      "Type": "List<AWS::EC2::Subnet::Id>",
      "Description": "Select the PRIVATE subnet(s) for the EKS nodes"
    },
    "EKSNodesSecurityGroups": {
      "Type": "List<AWS::EC2::SecurityGroup::Id>",
      "Description": "Select the security groups for the EKS nodes"
    },
    "BastionHostImageId": {
      "Type": "AWS::EC2::Image::Id",
      "Description": "Enter the AMI Id (prefably Amazon Linux 2) for the bastion host"
    },
    "BastionHostKeyPair": {
      "Type": "AWS::EC2::KeyPair::KeyName",
      "Description": "Select the key pair for the EKS bastion host"
    },
    "BastionHostSubnet": {
      "Type": "AWS::EC2::Subnet::Id",
      "Description": "Select a PUBLIC subnet for the EKS bastion host"
    },
    "BastionHostSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup::Id",
      "Description": "Select the security group for the EKS bastion host"
    }
  },
  "Resources": {
    "EKSClusterServiceRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "Service": ["eks.amazonaws.com"]
              },
              "Action": ["sts:AssumeRole"]
            }
          ]
        },
        "ManagedPolicyArns": ["arn:aws:iam::aws:policy/AmazonEKSClusterPolicy"]
      }
    },
    "EKSNodeServiceRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "Service": ["ec2.amazonaws.com"]
              },
              "Action": ["sts:AssumeRole"]
            }
          ]
        },
        "Path": "/",
        "Policies": [
          {
            "PolicyName": "EKSNodeServiceRolePolicy",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "ecr:GetAuthorizationToken",
                    "ecr:BatchCheckLayerAvailability",
                    "ecr:GetDownloadUrlForLayer",
                    "ecr:GetRepositoryPolicy",
                    "ecr:DescribeRepositories",
                    "ecr:ListImages",
                    "ecr:BatchGetImage"
                  ],
                  "Resource": "*"
                }
              ]
            }
          }
        ],
        "ManagedPolicyArns": [
          "arn:aws:iam::aws:policy/AmazonEKSWorkerNodePolicy",
          "arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryReadOnly",
          "arn:aws:iam::aws:policy/AmazonEKS_CNI_Policy"
        ]
      }
    },
    "EKSCluster": {
      "Type": "AWS::EKS::Cluster",
      "Properties": {
        "Name": { "Ref": "Project" },
        "Version": "1.21",
        "RoleArn": { "Fn::GetAtt": "EKSClusterServiceRole.Arn" },
        "ResourcesVpcConfig": {
          "SecurityGroupIds": { "Ref": "EKSNodesSecurityGroups" },
          "SubnetIds": { "Ref": "EKSNodesSubnets" },
          "EndpointPublicAccess": false,
          "EndpointPrivateAccess": true,
          "PublicAccessCidrs": ["1.1.1.2/32"]
        },
        "Logging": {
          "ClusterLogging": {
            "EnabledTypes": [
              {
                "Type": "api"
              },
              {
                "Type": "audit"
              }
            ]
          }
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": { "Fn::Join": ["-", [{ "Ref": "Project" }, "EKSCluster"]] }
          },
          { "Key": "Environment", "Value": { "Ref": "Environment" } }
        ]
      }
    },
    "EKSNodeGroup": {
      "Type": "AWS::EKS::Nodegroup",
      "Properties": {
        "ClusterName": { "Ref": "EKSCluster" },
        "NodeRole": { "Fn::GetAtt": "EKSNodeServiceRole.Arn" },
        "ScalingConfig": {
          "MinSize": 0,
          "DesiredSize": 2,
          "MaxSize": 2
        },
        "InstanceTypes": ["t3.micro"],
        "Labels": {
          "Type": "EC2NodeGroup"
        },
        "Subnets": { "Ref": "EKSNodesSubnets" }
      }
    },
    "EKSBastionHost" : {
      "Type" : "AWS::EC2::Instance",
      "Properties" : {
        "ImageId" : { "Ref": "BastionHostImageId" },
        "InstanceType": "t3.micro",
        "KeyName" : { "Ref" : "BastionHostKeyPair" },
        "NetworkInterfaces": [ {
          "AssociatePublicIpAddress": "true",
          "DeviceIndex": "0",
          "GroupSet": [{ "Fn::GetAtt": "EKSCluster.ClusterSecurityGroupId" }, { "Ref": "BastionHostSecurityGroup" }],
          "SubnetId": { "Ref" : "BastionHostSubnet" }
        } ],
        "Tags": [
          {
            "Key": "Name",
            "Value": { "Fn::Join": ["-", [{ "Ref": "Project" }, "EKSBastionHost"]] }
          },
          { "Key": "Environment", "Value": { "Ref": "Environment" } }
        ]
      }
    }
  },
  "Outputs": {
    "EKSBastionHostPublicIP": {
      "Value": { "Fn::GetAtt": "EKSBastionHost.PublicIp" }
    },
    "EKSClusterDefaultSecurityGroupId": {
      "Value": { "Fn::GetAtt": "EKSCluster.ClusterSecurityGroupId" }
    }
  }
}
